<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucro Real - Motorista & Motoboy</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        :root {
            --primary: #2563eb;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f4f7f6;
            --card: #ffffff;
            --text: #1e293b;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
        body { background-color: var(--bg); color: var(--text); padding-bottom: 50px; }

        header { background: var(--primary); color: white; padding: 1.5rem; text-align: center; border-radius: 0 0 20px 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        main { padding: 1rem; max-width: 500px; margin: auto; }

        .card { background: var(--card); padding: 1.2rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 1rem; }
        h2 { font-size: 1.1rem; margin-bottom: 1rem; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; }

        .input-group { margin-bottom: 1rem; }
        label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 0.4rem; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; outline-color: var(--primary); }

        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.2s; }
        .btn-calc { background: var(--primary); color: white; }
        .btn-calc:active { transform: scale(0.98); }
        .btn-clear { background: transparent; color: var(--danger); font-size: 0.8rem; margin-top: 1rem; border: 1px solid var(--danger); }

        /* Estilos de Resultado */
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .res-card { padding: 10px; border-radius: 8px; background: #f8fafc; border-left: 4px solid var(--primary); }
        .res-card span { display: block; font-size: 0.75rem; color: #64748b; }
        .res-card strong { font-size: 1.1rem; }

        .highlight-card { grid-column: span 2; text-align: center; padding: 20px; }
        .highlight-card strong { font-size: 1.8rem; display: block; }

        .alert-prejuizo { background: #fee2e2; border-color: var(--danger); color: var(--danger); }
        .alert-ok { background: #dcfce7; border-color: var(--success); color: var(--success); }

        .frase-dinamica { font-style: italic; font-size: 0.9rem; text-align: center; margin-top: 1rem; color: #475569; }

        #historico-lista { margin-top: 10px; }
        .hist-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.85rem; }

        /* --- NOVAS ESTILIZA√á√ïES --- */
        .meta-container { margin: 15px 0; background: #eee; border-radius: 10px; height: 20px; overflow: hidden; position: relative; }
        .meta-bar { background: var(--success); height: 100%; width: 0%; transition: 0.5s; }
        .meta-text { position: absolute; width: 100%; text-align: center; font-size: 0.7rem; top: 2px; font-weight: bold; }

        .afiliados-section { background: #eff6ff; border: 1px dashed var(--primary); padding: 10px; border-radius: 8px; margin-top: 15px; }
        .afiliados-title { font-size: 0.75rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; display: block; }
        .btn-afiliado { background: white; border: 1px solid #bfdbfe; padding: 8px; border-radius: 5px; display: block; text-decoration: none; color: #1e40af; font-size: 0.8rem; text-align: center; margin-bottom: 5px; }

        /* ESTILO DA TELA DE BLOQUEIO */
        #bloqueioSeguranca {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 99999; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            padding: 30px; text-align: center;
        }
    </style>
</head>
<body>

<div id="introApp" style="padding: 20px; text-align: center; background: white; border-radius: 0 0 30px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
    <h2 style="color: var(--primary); font-size: 1.5rem;">üöÄ M√°quina de Lucro Real</h2>
    <p style="margin: 10px 0; font-size: 0.9rem; color: #64748b;">Descubra quanto voc√™ ganha *de verdade* por hora e por KM rodado.</p>
    
    <div style="display: flex; gap: 10px; justify-content: center; margin: 15px 0;">
        <span style="font-size: 0.75rem; background: #dcfce7; color: #166534; padding: 5px 10px; border-radius: 20px;">‚úì Lucro L√≠quido Real</span>
        <span style="font-size: 0.75rem; background: #dcfce7; color: #166534; padding: 5px 10px; border-radius: 20px;">‚úì Meta Di√°ria</span>
    </div>
</div>    

<div id="bloqueioSeguranca" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:99999; display:none; flex-direction:column; overflow-y: auto;">
    
    <div style="background: linear-gradient(135deg, var(--primary), #1e40af); color: white; padding: 40px 20px; text-align: center; border-radius: 0 0 30px 30px;">
        <h2 style="font-size: 1.8rem; margin-bottom: 10px; color: white;">üí∞ Pare de trabalhar de gra√ßa!</h2>
        <p style="opacity: 0.9; font-size: 1rem;">Muitos motoristas pagam para trabalhar e n√£o sabem. Descubra seu **Lucro Real** agora.</p>
    </div>

    <div style="padding: 25px;">
        <div style="margin-bottom: 25px;">
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <span style="font-size: 1.5rem; margin-right: 15px;">üìä</span>
                <p style="font-size: 0.95rem;"><b>Controle Total:</b> Saiba exatamente quanto sobra ap√≥s gasolina, taxas e manuten√ß√£o.</p>
            </div>
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <span style="font-size: 1.5rem; margin-right: 15px;">üéØ</span>
                <p style="font-size: 0.95rem;"><b>Meta Inteligente:</b> Veja quanto falta para bater sua meta do dia em tempo real.</p>
            </div>
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <span style="font-size: 1.5rem; margin-right: 15px;">üìà</span>
                <p style="font-size: 0.95rem;"><b>Hist√≥rico Mensal:</b> N√£o perca suas contas. Tudo salvo para voc√™ evoluir.</p>
            </div>
        </div>

        <div style="background: #f8fafc; padding: 20px; border-radius: 15px; border: 1px solid #e2e8f0; text-align: center;">
            <h3 style="color: var(--text); margin-bottom: 5px;">Acesso Premium Liberado</h3>
            <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 15px;">Tenha a ferramenta definitiva por apenas:</p>
            <div style="font-size: 2rem; font-weight: bold; color: var(--success); margin-bottom: 15px;">R$ 9,90 <span style="font-size: 0.9rem; color: #64748b;">/m√™s</span></div>
            
            <a id="btnPagar" href="#" target="_blank" style="background: var(--success); color: white; padding: 18px; width: 100%; border-radius: 10px; text-decoration: none; font-weight: bold; display: block; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3);">QUERO COME√áAR AGORA</a>
        </div>

        <div style="margin-top: 30px; text-align: center;">
            <p style="font-size: 0.85rem; color: #64748b;">J√° pagou? Seu ID de ativa√ß√£o √©:</p>
            <div id="meuID" style="font-size: 1.4rem; font-weight: bold; margin: 10px 0; color: var(--primary); letter-spacing: 2px;">0000</div>
            
            <a id="btnZapAcesso" href="#" style="color: var(--primary); text-decoration: underline; font-weight: bold; font-size: 0.9rem;">J√° paguei, enviar ID pelo WhatsApp</a>

            <div style="margin-top: 25px; padding: 15px; border-top: 1px solid #eee;">
                <label style="font-size: 0.8rem; font-weight: bold;">Ativar com minha chave:</label>
                <input type="number" id="inputChave" placeholder="Cole sua chave aqui" style="margin-top: 5px; text-align: center;">
                <button onclick="validarChave()" style="background: var(--text); color: white; margin-top: 10px; padding: 12px;">ATIVAR ACESSO</button>
            </div>
        </div>
    </div>
</div>

<header>
    <h1>Lucro Real</h1>
    <p>Calculadora do Motorista & Motoboy</p>
</header>

<main id="appMain">
    <section class="card" style="background: linear-gradient(135deg, #1e293b, #334155); color: white; border: none; padding: 20px;">
        <div id="statusTrabalhando" style="display: none; text-align: center;">
            <div class="pulse-icon" style="color: #4ade80; font-size: 0.8rem; font-weight: bold; margin-bottom: 8px; letter-spacing: 1px;">
                ‚óè JORNADA ATIVA
            </div>
            <div id="cronometroDisplay" style="font-size: 2.5rem; font-family: 'Courier New', monospace; font-weight: bold; text-shadow: 0 0 15px rgba(74, 222, 128, 0.3);">
                00:00:00
            </div>
            <p style="margin-top: 10px; font-size: 0.8rem; opacity: 0.8;">O lucro por hora est√° sendo calculado...</p>
        </div>

        <div id="statusOffline" style="text-align: center; padding: 10px;">
            <div style="font-size: 2rem; margin-bottom: 10px;">üöó</div>
            <h2 style="color: white; margin: 0; font-size: 1.3rem;">Pronto para Rodar?</h2>
            <p style="margin: 5px 0 0 0; opacity: 0.7; font-size: 0.85rem;">Inicie o turno para rastrear seus ganhos.</p>
        </div>
    </section>

    <section class="card" id="fluxoInicio">
        <h2 style="color: var(--success); font-size: 1.1rem; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
            üöÄ Abrir Dia
        </h2>
        <div class="input-group">
            <label>KM Inicial no Painel</label>
            <input type="number" id="kmInicial" placeholder="Ex: 45000" style="font-size: 1.1rem;">
        </div>
        <div class="input-group">
            <label>Gasto com Combust√≠vel (R$)</label>
            <input type="number" id="gasInicial" value="0" placeholder="R$ 0,00">
        </div>
        <button class="btn-calc" style="background: var(--success); color: white; font-weight: bold; font-size: 1rem; padding: 15px;" onclick="abrirDia()">
            INICIAR JORNADA AGORA
        </button>
    </section>

    <section class="card">
        <h2 style="font-size: 0.85rem; color: #64748b; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;">‚öôÔ∏è Ajustes de C√°lculo</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="input-group">
                <label>Taxa App (%)</label>
                <input type="number" id="taxaApp" value="25">
            </div>
            <div class="input-group">
                <label>Manut/KM (R$)</label>
                <input type="number" id="depreKM" value="0.20" step="0.01">
            </div>
            <div class="input-group">
                <label>Meta (R$)</label>
                <input type="number" id="metaDiaria" value="150">
            </div>
            <div class="input-group">
                <label>Extra/Comida</label>
                <input type="number" id="outrosCustos" value="0">
            </div>
        </div>
        <div class="input-group" style="margin-top: 10px;">
            <label>Tipo de Ve√≠culo</label>
            <select id="tipo" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1;">
                <option value="motorista">üöó Carro (App)</option>
                <option value="motoboy">üèçÔ∏è Motoboy (Entrega)</option>
            </select>
        </div>
    </section>

    <section class="card" id="fluxoFim" style="display: none;">
        <h2 style="color: var(--danger); font-size: 1.1rem; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
            üèÅ Fechar Dia
        </h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f1f5f9; padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary);">
            <div>
                <small style="color: #64748b; font-weight: bold;">Iniciado √†s</small><br>
                <strong id="txtHoraInicio" style="color: var(--primary);">--:--</strong>
            </div>
            <div>
                <small style="color: #64748b; font-weight: bold;">KM Partida</small><br>
                <strong id="txtKmInicial" style="color: var(--primary);">0</strong>
            </div>
        </div>
        <div class="input-group">
            <label>KM Final Atual</label>
            <input type="number" id="kmFinal" placeholder="Ex: 45220" style="font-size: 1.1rem;">
        </div>
        <div class="input-group">
            <label>Total Bruto Ganhado (Apps)</label>
            <input type="number" id="ganhoTotal" placeholder="R$ 0,00" style="font-size: 1.1rem; border: 2px solid #e2e8f0;">
        </div>
        <button class="btn-calc" style="background: var(--primary); color: white; font-weight: bold; padding: 18px; font-size: 1.1rem;" onclick="fecharDia()">
            FINALIZAR E CALCULAR LUCRO
        </button>
        <button class="btn-clear" onclick="cancelarJornada()" style="margin-top: 15px; width: 100%; border: none; background: transparent; color: #94a3b8; font-size: 0.8rem;">
            Cancelar turno sem salvar
        </button>
    </section>

    <section class="card" id="resultadoSection" style="display: none; border-top: 6px solid var(--success);">
        <div style="text-align: center; margin-bottom: 15px;">
            <h2 style="margin: 0; font-size: 1.2rem;">üèÜ Resumo da Miss√£o</h2>
        </div>
        <div class="res-grid">
            <div id="statusCard" class="res-card highlight-card" style="grid-column: span 2; background: #f0fdf4; padding: 20px;">
                <span style="font-size: 0.8rem; color: #166534; font-weight: bold;">DINHEIRO LIMPO NO BOLSO</span>
                <strong id="resLucro" style="font-size: 2.2rem; display: block; color: #15803d;">R$ 0,00</strong>
            </div>
            <div class="res-card"><span>R$ / Hora</span><strong id="resHora">R$ 0,00</strong></div>
            <div class="res-card"><span>R$ / KM</span><strong id="resKM">R$ 0,00</strong></div>
            <div class="res-card"><span>Tempo Online</span><strong id="resTempo">0h 0m</strong></div>
            <div class="res-card"><span>Total Rodado</span><strong id="resKmTotal">0 km</strong></div>
        </div>
        <div style="margin-top: 25px;">
            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 5px; font-weight: bold;">
                <span>Progresso da Meta</span>
                <span id="metaPercent">0%</span>
            </div>
            <div style="background: #e2e8f0; border-radius: 50px; height: 12px; overflow: hidden;">
                <div id="metaBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #4ade80, #22c55e); transition: width 1.5s ease-in-out;"></div>
            </div>
            <p id="valeAPena" style="text-align: center; font-weight: bold; margin-top: 15px; font-size: 1rem;"></p>
        </div>
    </section>

    <section class="card">
        <h2 style="font-size: 1rem;">üìÖ Hist√≥rico Salvo</h2>
        <div id="historico-lista" style="font-size: 0.85rem; color: #64748b;"></div>
        <button class="btn-clear" onclick="limparHistorico()" style="margin-top: 10px;">Limpar Tudo</button>
    </section>
</main>

<script>
    // --- CONFIGURA√á√ïES DO DONO DO APP ---
    const MEU_WHATSAPP = "5511962356998"; 
    const LINK_PAGAMENTO = "https://mpago.la/2M2EUUp";
    const SEGREDO_SOMA = 888; 
    const SALARIO_MIN_HORA = 12.00;

    function gerenciarSeguranca() {
    // 1. Define o ID √∫nico
    let userID = localStorage.getItem('app_user_unique_id');
    if (!userID) {
        userID = Math.floor(1000 + Math.random() * 8999);
        localStorage.setItem('app_user_unique_id', userID);
    }

    // 2. Pega os elementos do HTML
    const elID = document.getElementById('meuID');
    const bloqueio = document.getElementById('bloqueioSeguranca');
    const app = document.getElementById('appMain');
    const intro = document.getElementById('introApp');
    const btnZap = document.getElementById('btnZapAcesso');

    // 3. Define a data atual para o c√°lculo
    const data = new Date();
    const mes = data.getMonth() + 1;
    const ano = data.getFullYear();

    // 4. Mostra o ID na tela de bloqueio
    if (elID) elID.innerText = userID;

    // 5. Configura o link do WhatsApp (Aqui era onde dava o erro)
    if (btnZap) {
        const msg = encodeURIComponent(`Ol√°! J√° paguei o acesso.\nID: ${userID}\nM√™s: ${mes}/${ano}`);
        btnZap.href = `https://wa.me/${MEU_WHATSAPP}?text=${msg}`;
    }

    // 6. L√≥gica de Verifica√ß√£o
    const chaveSalva = localStorage.getItem('chave_sucesso_ativada');
    const calculoCorreto = (parseInt(userID) * 3) + SEGREDO_SOMA + mes + ano;

    if (chaveSalva && parseInt(chaveSalva) === calculoCorreto) {
        if (bloqueio) bloqueio.style.display = 'none';
        if (app) app.style.display = 'block';
        if (intro) intro.style.display = 'block';
    } else {
        if (bloqueio) bloqueio.style.display = 'flex';
        if (app) app.style.display = 'none';
        if (intro) intro.style.display = 'none';
    }
    };


        // Usamos um pequeno delay para garantir que o HTML carregou totalmente antes de mexer no CSS
        setTimeout(() => {
            const elID = document.getElementById('meuID');
            if (elID) elID.innerText = userID;

            const data = new Date();
            const mes = data.getMonth() + 1;
            const ano = data.getFullYear();

            // Configura Links
            const btnPagar = document.getElementById('btnPagar');
            if(btnPagar) btnPagar.href = LINK_PAGAMENTO;

            const btnZap = document.getElementById('btnZapAcesso');
            if(btnZap) {
                const msg = encodeURIComponent(`J√° paguei! Libera meu acesso?\nID: ${userID}\nM√™s: ${mes}/${ano}`);
                btnZap.href = `https://wa.me/${MEU_WHATSAPP}?text=${msg}`;
            }

            // 4. VERIFICA√á√ÉO DE CHAVE SALVA
            const chaveSalva = localStorage.getItem('chave_sucesso_ativada');
            const calculoMensalCorreto = (parseInt(userID) * 3) + SEGREDO_SOMA + mes + ano;

            const bloqueio = document.getElementById('bloqueioSeguranca');
            const app = document.getElementById('appMain');
            const intro = document.getElementById('introApp');

            // 5. L√ìGICA DE EXIBI√á√ÉO PERSISTENTE
            if (chaveSalva && parseInt(chaveSalva) === calculoMensalCorreto) {
                if(bloqueio) bloqueio.style.display = 'none';
                if(app) app.style.display = 'block';
                if(intro) intro.style.display = 'block';
            } else {
                if(bloqueio) bloqueio.style.display = 'flex';
                if(app) app.style.display = 'none';
                if(intro) intro.style.display = 'none';
            }
        }, 100); 
    

    function validarChave() {
        const idAparelho = document.getElementById('meuID').innerText;
        const chaveDigitada = document.getElementById('inputChave').value;
        const data = new Date();
        const mes = data.getMonth() + 1;
        const ano = data.getFullYear();
        
        const calculoValido = (parseInt(idAparelho) * 3) + SEGREDO_SOMA + mes + ano;

        if (parseInt(chaveDigitada) === calculoValido) {
            localStorage.setItem('chave_sucesso_ativada', chaveDigitada);
            alert("‚úÖ Acesso mensal liberado! Boas corridas.");
            location.reload(); // Recarrega para aplicar o desbloqueio permanentemente
        } else {
            alert("‚ùå Chave inv√°lida ou vencida. Verifique o m√™s atual.");
        }
    }

    function calcular() {
        const bruto = parseFloat(document.getElementById('ganhoBruto').value) || 0;
        const horas = parseFloat(document.getElementById('horas').value) || 1;
        const km = parseFloat(document.getElementById('km').value) || 1;
        const combustivel = parseFloat(document.getElementById('combustivel').value) || 0;
        const taxaPerc = parseFloat(document.getElementById('taxaApp').value) || 0;
        const depreKM = parseFloat(document.getElementById('depreKM').value) || 0;
        const outros = parseFloat(document.getElementById('outrosCustos').value) || 0;
        const meta = parseFloat(document.getElementById('metaDiaria').value) || 1;

        const valorTaxaApp = bruto * (taxaPerc / 100);
        const custoManutencao = km * depreKM;
        const custosTotais = valorTaxaApp + combustivel + outros + custoManutencao;
        const lucroLiquido = bruto - custosTotais;
        const ganhoHora = lucroLiquido / horas;
        const ganhoKM = lucroLiquido / km;

        document.getElementById('resultadoSection').style.display = 'block';
        document.getElementById('resLucro').innerText = `R$ ${lucroLiquido.toFixed(2)}`;
        document.getElementById('resHora').innerText = `R$ ${ganhoHora.toFixed(2)}`;
        document.getElementById('resKM').innerText = `R$ ${ganhoKM.toFixed(2)}`;
        document.getElementById('resTaxa').innerText = `R$ ${valorTaxaApp.toFixed(2)}`;
        document.getElementById('resDepre').innerText = `R$ ${custoManutencao.toFixed(2)}`;

        const porcMeta = Math.min((lucroLiquido / meta) * 100, 100);
        document.getElementById('metaBar').style.width = (porcMeta > 0 ? porcMeta : 0) + '%';
        document.getElementById('metaText').innerText = `${porcMeta.toFixed(0)}% da meta batida`;

        const statusCard = document.getElementById('statusCard');
        const valeAPena = document.getElementById('valeAPena');
        
        if (lucroLiquido <= 0) {
            statusCard.className = 'res-card highlight-card alert-prejuizo';
            document.getElementById('labelLucro').innerText = 'PREJU√çZO!';
            valeAPena.innerText = "‚ùå Hoje n√£o valeu a pena.";
            valeAPena.style.color = "var(--danger)";
        } else {
            statusCard.className = 'res-card highlight-card alert-ok';
            document.getElementById('labelLucro').innerText = 'LUCRO L√çQUIDO';
            
            if (ganhoHora < SALARIO_MIN_HORA) {
                valeAPena.innerText = "‚ö†Ô∏è O ganho por hora est√° baixo!";
                valeAPena.style.color = "var(--warning)";
            } else {
                valeAPena.innerText = "‚úÖ Valeu a pena! Bom trabalho.";
                valeAPena.style.color = "var(--success)";
            }
        }

        document.getElementById('fraseDinamica').innerText = 
            `Voc√™ trabalhou ${horas} horas hoje para ganhar R$ ${lucroLiquido.toFixed(2)} l√≠quidos.`;

        salvarRegistro(lucroLiquido);
        carregarHistorico();
    }
// --- VARI√ÅVEIS GLOBAIS ---
let intervaloCronometro;

// --- 1. CONTROLE DE INTERFACE (AQUI EST√Å A CORRE√á√ÉO) ---
function alternarTelas(estaTrabalhando) {
    const fluxoInicio = document.getElementById('fluxoInicio');
    const fluxoFim = document.getElementById('fluxoFim');
    const statusTrabalhando = document.getElementById('statusTrabalhando');
    const statusOffline = document.getElementById('statusOffline');
    const resultadoSection = document.getElementById('resultadoSection');

    if (estaTrabalhando) {
        fluxoInicio.style.display = 'none';
        fluxoFim.style.display = 'block';
        statusTrabalhando.style.display = 'block';
        statusOffline.style.display = 'none';
        
        // Recupera dados para o resumo do topo
        const dados = JSON.parse(localStorage.getItem('turnoAtivo'));
        if (dados) {
            document.getElementById('txtKmInicial').innerText = dados.km;
            const horaBr = new Date(dados.hora).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('txtHoraInicio').innerText = horaBr;
        }
    } else {
        fluxoInicio.style.display = 'block';
        fluxoFim.style.display = 'none';
        statusTrabalhando.style.display = 'none';
        statusOffline.style.display = 'block';
    }
}

// --- 2. L√ìGICA DO CRON√îMETRO ---
function atualizarCronometro() {
    const dadosIniciais = JSON.parse(localStorage.getItem('turnoAtivo'));
    if (!dadosIniciais) {
        clearInterval(intervaloCronometro);
        return;
    }

    const inicio = new Date(dadosIniciais.hora);
    const agora = new Date();
    const diff = agora - inicio;

    const h = Math.floor(diff / (1000 * 60 * 60));
    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const s = Math.floor((diff % (1000 * 60)) / 1000);

    const display = 
        (h < 10 ? "0" + h : h) + ":" + 
        (m < 10 ? "0" + m : m) + ":" + 
        (s < 10 ? "0" + s : s);

    const el = document.getElementById('cronometroDisplay');
    if (el) el.innerText = display;
}

// --- 3. A√á√ïES DO USU√ÅRIO ---
function abrirDia() {
    const kmInic = document.getElementById('kmInicial').value;
    if (!kmInic) {
        alert("‚ö†Ô∏è Por favor, informe o KM Inicial!");
        return;
    }

    const dadosInicios = {
        km: parseFloat(kmInic),
        hora: new Date().toISOString(),
        gas: parseFloat(document.getElementById('gasInicial').value) || 0
    };

    localStorage.setItem('turnoAtivo', JSON.stringify(dadosInicios));

    // Inicia Rel√≥gio
    clearInterval(intervaloCronometro);
    intervaloCronometro = setInterval(atualizarCronometro, 1000);

    alternarTelas(true);
}

function fecharDia() {
    const dadosIniciais = JSON.parse(localStorage.getItem('turnoAtivo'));
    if (!dadosIniciais) return;

    const kmFinal = parseFloat(document.getElementById('kmFinal').value);
    const ganhoBrutoApp = parseFloat(document.getElementById('ganhoTotal').value) || 0;

    if (!kmFinal || kmFinal <= dadosIniciais.km) {
        alert("O KM final deve ser maior que o inicial!");
        return;
    }

    const agora = new Date();
    const inicio = new Date(dadosIniciais.hora);
    let diffHoras = (agora - inicio) / (1000 * 60 * 60);
    
    if (diffHoras < 0.016) diffHoras = 0.016; 

    const kmTotal = kmFinal - dadosIniciais.km;
    const taxaApp = (parseFloat(document.getElementById('taxaApp').value) || 0) / 100;
    const manutKM = parseFloat(document.getElementById('depreKM').value) || 0;
    const outros = parseFloat(document.getElementById('outrosCustos').value) || 0;

    const lucro = ganhoBrutoApp - (ganhoBrutoApp * taxaApp) - (dadosIniciais.gas || 0) - (kmTotal * manutKM) - outros;

    const ganhoPorHora = lucro / diffHoras;
    const ganhoPorKm = kmTotal > 0 ? (lucro / kmTotal) : 0;

    // 1. Exibir na tela (Dopamina)
    exibirResultados(lucro, ganhoPorHora, ganhoPorKm, diffHoras, kmTotal);

    // --- A LINHA QUE FALTAVA EST√Å AQUI EMBAIXO ---
    // 2. Salvar no banco de dados do navegador
    salvarNoHistorico(lucro, kmTotal, diffHoras);
    // --------------------------------------------

    // 3. Finaliza√ß√£o
    clearInterval(intervaloCronometro);
    localStorage.removeItem('turnoAtivo');
    
    // 4. Voltar para a tela inicial
    if (typeof alternarTelas === "function") {
        alternarTelas(false);
    }

    console.log("Turno finalizado e salvo no hist√≥rico!");
}
    function salvarNoHistorico(lucro, km, tempo) {
    // Busca o que j√° existe ou cria uma lista vazia
    let historico = JSON.parse(localStorage.getItem('historico_jornadas')) || [];
    
    // Cria o objeto com a data atual
    const novaJornada = {
        data: new Date().toLocaleDateString('pt-BR'),
        lucro: lucro,
        km: km,
        tempo: tempo
    };

    // Adiciona ao in√≠cio da lista (unshift)
    historico.unshift(novaJornada);

    // Guarda de volta no navegador
    localStorage.setItem('historico_jornadas', JSON.stringify(historico));

    // Atualiza a visualiza√ß√£o na tela
    carregarHistorico();
}
    
    function carregarHistorico() {
    const container = document.getElementById('historico-lista');
    if (!container) return;

    const historico = JSON.parse(localStorage.getItem('historico_jornadas')) || [];
    
    if (historico.length === 0) {
        container.innerHTML = '<p style="color: #94a3b8; font-size: 0.8rem; text-align: center;">Nenhum registro encontrado.</p>';
        return;
    }

    container.innerHTML = historico.map(item => `
        <div style="border-bottom: 1px solid #e2e8f0; padding: 10px 0; display: flex; justify-content: space-between;">
            <div>
                <small style="color: #64748b;">${item.data}</small><br>
                <strong>${item.lucro.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</strong>
            </div>
            <div style="text-align: right; font-size: 0.8rem;">
                ${item.km.toFixed(1)} km <br>
                ${Math.floor(item.tempo)}h ${Math.round((item.tempo % 1) * 60)}m
            </div>
        </div>
    `).join('');
}

function exibirResultados(lucro, gHora, gKm, tempo, kmTotal) {
    // Mostra a se√ß√£o de resultados
    document.getElementById('resultadoSection').style.display = 'block';

    // Formata o Lucro, Ganho/Hora e Ganho/KM
    document.getElementById('resLucro').innerText = lucro.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    document.getElementById('resHora').innerText = gHora.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    document.getElementById('resKM').innerText = gKm.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    
    // Formata a Dist√¢ncia
    document.getElementById('resKmTotal').innerText = kmTotal.toFixed(1) + " km";

    // --- FORMATA√á√ÉO DO TEMPO ONLINE (AQUI ESTAVA O PROBLEMA) ---
    const horasInteiras = Math.floor(tempo);
    const minutosRestantes = Math.round((tempo - horasInteiras) * 60);
    
    // Exibe no ID resTempo (certifique-se que o ID no HTML √© este)
    document.getElementById('resTempo').innerText = horasInteiras + "h " + minutosRestantes + "m";

    // Barra de Meta
    const metaDiaria = parseFloat(document.getElementById('metaDiaria').value) || 1;
    const pct = Math.min((lucro / metaDiaria) * 100, 100);
    
    const metaBar = document.getElementById('metaBar');
    if (metaBar) metaBar.style.width = pct + "%";
    
    const metaText = document.getElementById('metaText');
    if (metaText) metaText.innerText = Math.floor(pct) + "% da meta batida";

    // Scroll suave para os resultados para gerar dopamina
    window.scrollTo({ top: document.getElementById('resultadoSection').offsetTop, behavior: 'smooth' });
}

function cancelarJornada() {
    if (confirm("Deseja cancelar o turno atual? Dados n√£o ser√£o salvos.")) {
        clearInterval(intervaloCronometro);
        localStorage.removeItem('turnoAtivo');
        alternarTelas(false);
    }
}

// --- 4. INICIALIZA√á√ÉO ---
window.onload = function() {
    const salvo = localStorage.getItem('turnoAtivo');
    if (salvo) {
        alternarTelas(true);
        atualizarCronometro();
        intervaloCronometro = setInterval(atualizarCronometro, 1000);
    } else {
        alternarTelas(false);
    }
};

function exibirResultados(lucro, gHora, gKm, tempo, kmTotal) {
    const section = document.getElementById('resultadoSection');
    if (section) section.style.display = 'block';

    // Fun√ß√£o auxiliar para evitar o erro de 'null'
    const setTexto = (id, valor) => {
        const el = document.getElementById(id);
        if (el) el.innerText = valor;
    };

    setTexto('resLucro', lucro.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }));
    setTexto('resHora', gHora.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }));
    setTexto('resKM', gKm.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }));
    setTexto('resKmTotal', kmTotal.toFixed(1) + " km");

    // Formata√ß√£o do Tempo
    const h = Math.floor(tempo);
    const m = Math.round((tempo - h) * 60);
    setTexto('resTempo', h + "h " + m + "m");

    // Barra de Meta com Verifica√ß√£o
    const metaDiaria = parseFloat(document.getElementById('metaDiaria')?.value) || 1;
    const pct = Math.min((lucro / metaDiaria) * 100, 100);
    
    const metaBar = document.getElementById('metaBar');
    if (metaBar) metaBar.style.width = pct + "%";

    const metaText = document.getElementById('metaText');
    if (metaText) metaText.innerText = Math.floor(pct) + "% da meta batida";

    const metaPercent = document.getElementById('metaPercent');
    if (metaPercent) metaPercent.innerText = Math.floor(pct) + "%";

    // Scroll Suave
    if (section) window.scrollTo({ top: section.offsetTop, behavior: 'smooth' });
}

function executarCalculoFinal(bruto, km, horas, combustivel) {
    // Busca configura√ß√µes das taxas
    const taxaPerc = parseFloat(document.getElementById('taxaApp').value) || 0;
    const depreKM = parseFloat(document.getElementById('depreKM').value) || 0;
    const outros = parseFloat(document.getElementById('outrosCustos').value) || 0;
    const meta = parseFloat(document.getElementById('metaDiaria').value) || 1;

    // L√≥gica Financeira
    const valorTaxaApp = bruto * (taxaPerc / 100);
    const custoManutencao = km * depreKM;
    const custosTotais = valorTaxaApp + combustivel + outros + custoManutencao;
    const lucroLiquido = bruto - custosTotais;

    // C√ÅLCULO DE GANHO POR HORA (CORRIGIDO)
    const ganhoHora = lucroLiquido / horas;
    const ganhoKM = lucroLiquido / (km > 0 ? km : 1);

    // EXIBI√á√ÉO NA TELA
    document.getElementById('resultadoSection').style.display = 'block';
    document.getElementById('resLucro').innerText = `R$ ${lucroLiquido.toFixed(2)}`;
    document.getElementById('resHora').innerText = `R$ ${ganhoHora.toFixed(2)}`;
    document.getElementById('resKM').innerText = `R$ ${ganhoKM.toFixed(2)}`;
    document.getElementById('resTaxa').innerText = `R$ ${valorTaxaApp.toFixed(2)}`;
    document.getElementById('resDepre').innerText = `R$ ${custoManutencao.toFixed(2)}`;

    // Atualiza Barra de Meta
    const porcMeta = Math.min((lucroLiquido / meta) * 100, 100);
    document.getElementById('metaBar').style.width = (porcMeta > 0 ? porcMeta : 0) + '%';
    document.getElementById('metaText').innerText = `${porcMeta.toFixed(0)}% da meta batida`;

    // Atualiza Alertas Visuais
    const statusCard = document.getElementById('statusCard');
    const valeAPena = document.getElementById('valeAPena');
    
    if (lucroLiquido <= 0) {
        statusCard.className = 'res-card highlight-card alert-prejuizo';
        document.getElementById('labelLucro').innerText = 'PREJU√çZO!';
        valeAPena.innerText = "‚ùå Hoje voc√™ pagou para trabalhar.";
    } else {
        statusCard.className = 'res-card highlight-card alert-ok';
        document.getElementById('labelLucro').innerText = 'LUCRO L√çQUIDO';
        valeAPena.innerText = ganhoHora < SALARIO_MIN_HORA ? "‚ö†Ô∏è Ganho/Hora muito baixo!" : "‚úÖ Valeu a pena!";
    }

    document.getElementById('fraseDinamica').innerText = 
        `Em ${horas.toFixed(1)}h rodadas, seu lucro real foi de R$ ${lucroLiquido.toFixed(2)}.`;

    salvarRegistro(lucroLiquido);
    carregarHistorico();
}

    function limparHistorico() {
        if(confirm("Deseja apagar todo o hist√≥rico?")) {
            localStorage.removeItem('historico_lucro');
            carregarHistorico();
            document.getElementById('resultadoSection').style.display = 'none';
        }
    }

    window.onload = function() {
    gerenciarSeguranca(); 

    const salvo = localStorage.getItem('turnoAtivo');
    if (salvo) {
        if (typeof alternarTelas === "function") alternarTelas(true);
        atualizarCronometro();
        intervaloCronometro = setInterval(atualizarCronometro, 1000);
    } else {
        if (typeof alternarTelas === "function") alternarTelas(false);
    }
    
    if (typeof carregarHistorico === "function") carregarHistorico();
};
</script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log("PWA Ativo!"))
      .catch(err => console.log("Erro PWA:", err));
  }
</script>
</body>
</html>
